<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HR Dashboard - GitHub Version</title>
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', Arial, sans-serif; 
            font-size: 0.9rem; 
            line-height: 1.5; 
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50vh;
            flex-direction: column;
        }
        
        .loading-text {
            margin-top: 1rem;
            color: #6c757d;
        }
        
        .error-container {
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem;
            color: #842029;
        }
        
        .dashboard-container {
            display: none;
        }
        
        .dashboard-container.loaded {
            display: block;
        }
        
        .github-config {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem;
        }
        
        .config-input {
            width: 100%;
            margin-bottom: 0.5rem;
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
        }
        
        /* Основные стили Dashboard */
        .header { 
            background-color: #f8f9fa; 
            border-bottom: 1px solid #dee2e6; 
            padding: 1rem;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        .table-responsive {
            margin-top: 1rem;
        }
        
        .kpi-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #198754;
        }
        
        .kpi-value.bad {
            color: #dc3545;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 1rem;
        }
        
        /* Темная тема */
        [data-bs-theme=dark] .header { 
            background-color: #2b3035; 
            border-color: #495057; 
        }
        
        [data-bs-theme=dark] .kpi-card {
            background: #212529;
            border-color: #495057;
            color: #fff;
        }
        
        [data-bs-theme=dark] .error-container {
            background-color: #2c0b0e;
            border-color: #842029;
            color: #ea868f;
        }
        
        [data-bs-theme=dark] .github-config {
            background-color: #0a1929;
            border-color: #1976d2;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h3 m-0">HR Dashboard - GitHub Version</h1>
            <div>
                <button class="btn btn-outline-secondary btn-sm me-2" id="theme-toggle">
                    <i class="bi bi-moon"></i> Тема
                </button>
                <button class="btn btn-outline-primary btn-sm" id="reload-data">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
            </div>
        </div>
    </div>

    <!-- Конфигурация GitHub -->
    <div class="github-config">
        <h5><i class="bi bi-github"></i> Конфигурация GitHub</h5>
        <p>Укажите URL к вашему GitHub репозиторию и названия файлов:</p>
        
        <div class="row">
            <div class="col-md-6">
                <label>GitHub Repository URL:</label>
                <input type="text" class="config-input" id="github-base-url" 
                       placeholder="https://raw.githubusercontent.com/username/repo/main/"
                       value="">
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-12">
                        <label>Excel файл с HR данными:</label>
                        <input type="text" class="config-input" id="excel-filename" 
                               placeholder="HR данные.xlsx" value="HR%20данные.xlsx">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <label>Excel файл Exit интервью:</label>
                <input type="text" class="config-input" id="exit-filename" 
                       placeholder="Exit интервью.xlsx" value="Exit%20интервью.xlsx">
            </div>
            <div class="col-md-6">
                <label>CSV файл eNPS:</label>
                <input type="text" class="config-input" id="enps-filename" 
                       placeholder="plan_enps_2024_1.csv" value="plan_enps_2024_1.csv">
            </div>
        </div>
        
        <button class="btn btn-primary mt-2" id="load-data">
            <i class="bi bi-download"></i> Загрузить данные
        </button>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
        <div class="loading-text">Загружаем данные из GitHub...</div>
    </div>

    <!-- Error Container -->
    <div class="error-container" id="error-container" style="display: none;">
        <h5><i class="bi bi-exclamation-triangle"></i> Ошибка загрузки данных</h5>
        <div id="error-message"></div>
        <hr>
        <small>
            <strong>Инструкции по настройке:</strong><br>
            1. Загрузите файлы Excel и CSV в ваш GitHub репозиторий<br>
            2. Укажите правильный URL репозитория в формате: https://raw.githubusercontent.com/username/repo/main/<br>
            3. Проверьте названия файлов (используйте URL-кодирование для пробелов: %20)<br>
            4. Убедитесь, что репозиторий публичный или файлы доступны по прямой ссылке
        </small>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-container" id="dashboard-container">
        <div class="main-content">
            <!-- Filters -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="branch-select" class="form-label">Филиал:</label>
                    <select class="form-select" id="branch-select">
                        <option value="">Все филиалы</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="year-select" class="form-label">Год:</label>
                    <select class="form-select" id="year-select">
                        <option value="">Все годы</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="month-select" class="form-label">Месяц:</label>
                    <select class="form-select" id="month-select">
                        <option value="">Все месяцы</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-success" id="export-excel">
                        <i class="bi bi-file-earmark-excel"></i> Экспорт Excel
                    </button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="row" id="kpi-cards">
                <!-- KPI карточки будут добавлены динамически -->
            </div>

            <!-- Data Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="data-table">
                    <thead class="table-dark">
                        <tr id="table-header">
                            <!-- Заголовки будут добавлены динамически -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Данные будут добавлены динамически -->
                    </tbody>
                </table>
            </div>

            <!-- Charts -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="kpi-card">
                        <h5>Динамика показателей</h5>
                        <div class="chart-container">
                            <canvas id="main-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <script>
        // Глобальные переменные
        let dashboardData = {
            branches: [],
            years: [],
            months: ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'],
            hrData: [],
            exitData: [],
            enpsData: []
        };

        let currentChart = null;

        // Конфигурация
        const CONFIG = {
            githubBaseUrl: '',
            files: {
                excel: 'HR%20данные.xlsx',
                exit: 'Exit%20интервью.xlsx',
                enps: 'plan_enps_2024_1.csv'
            }
        };

        // DOM элементы
        const elements = {
            githubBaseUrl: document.getElementById('github-base-url'),
            excelFilename: document.getElementById('excel-filename'),
            exitFilename: document.getElementById('exit-filename'),
            enpsFilename: document.getElementById('enps-filename'),
            loadDataBtn: document.getElementById('load-data'),
            reloadDataBtn: document.getElementById('reload-data'),
            loadingSpinner: document.getElementById('loading-spinner'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            dashboardContainer: document.getElementById('dashboard-container'),
            themeToggle: document.getElementById('theme-toggle'),
            branchSelect: document.getElementById('branch-select'),
            yearSelect: document.getElementById('year-select'),
            monthSelect: document.getElementById('month-select'),
            exportBtn: document.getElementById('export-excel'),
            kpiCards: document.getElementById('kpi-cards'),
            tableHeader: document.getElementById('table-header'),
            tableBody: document.getElementById('table-body'),
            mainChart: document.getElementById('main-chart')
        };

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            setupEventListeners();
            loadSavedConfig();
        });

        function setupEventListeners() {
            elements.loadDataBtn.addEventListener('click', loadAllData);
            elements.reloadDataBtn.addEventListener('click', loadAllData);
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.exportBtn.addEventListener('click', exportToExcel);
            
            // Фильтры
            elements.branchSelect.addEventListener('change', updateDashboard);
            elements.yearSelect.addEventListener('change', updateDashboard);
            elements.monthSelect.addEventListener('change', updateDashboard);
        }

        function loadSavedConfig() {
            const saved = localStorage.getItem('hr-dashboard-config');
            if (saved) {
                const config = JSON.parse(saved);
                elements.githubBaseUrl.value = config.githubBaseUrl || '';
                elements.excelFilename.value = config.excel || 'HR%20данные.xlsx';
                elements.exitFilename.value = config.exit || 'Exit%20интервью.xlsx';
                elements.enpsFilename.value = config.enps || 'plan_enps_2024_1.csv';
            }
        }

        function saveConfig() {
            const config = {
                githubBaseUrl: elements.githubBaseUrl.value,
                excel: elements.excelFilename.value,
                exit: elements.exitFilename.value,
                enps: elements.enpsFilename.value
            };
            localStorage.setItem('hr-dashboard-config', JSON.stringify(config));
            CONFIG.githubBaseUrl = config.githubBaseUrl;
            CONFIG.files = {
                excel: config.excel,
                exit: config.exit,
                enps: config.enps
            };
        }

        async function loadAllData() {
            try {
                saveConfig();
                showLoading();
                
                if (!CONFIG.githubBaseUrl) {
                    throw new Error('Не указан URL GitHub репозитория');
                }

                // Загружаем файлы параллельно
                const promises = [
                    loadExcelFile(),
                    loadExitInterviewsFile(),
                    loadEnpsFile()
                ];

                await Promise.all(promises);
                
                processData();
                setupFilters();
                updateDashboard();
                showDashboard();
                
            } catch (error) {
                showError(error.message);
            }
        }

        async function loadExcelFile() {
            const url = CONFIG.githubBaseUrl + CONFIG.files.excel;
            console.log('Loading Excel from:', url);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Не удалось загрузить Excel файл: ${response.status} ${response.statusText}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Предполагаем, что данные в первом листе или листе 'Data'
                const sheetName = workbook.SheetNames.includes('Data') ? 'Data' : workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                
                dashboardData.hrData = XLSX.utils.sheet_to_json(sheet);
                console.log('HR data loaded:', dashboardData.hrData.length, 'records');
                
            } catch (error) {
                console.error('Error loading Excel file:', error);
                throw new Error(`Ошибка загрузки Excel файла: ${error.message}`);
            }
        }

        async function loadExitInterviewsFile() {
            const url = CONFIG.githubBaseUrl + CONFIG.files.exit;
            console.log('Loading Exit interviews from:', url);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.warn('Exit interviews file not found, skipping');
                    return;
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                dashboardData.exitData = [];
                workbook.SheetNames.forEach(sheetName => {
                    const sheet = workbook.Sheets[sheetName];
                    const data = XLSX.utils.sheet_to_json(sheet);
                    dashboardData.exitData.push({ sheetName, data });
                });
                
                console.log('Exit interviews data loaded');
                
            } catch (error) {
                console.warn('Exit interviews file error:', error.message);
            }
        }

        async function loadEnpsFile() {
            const url = CONFIG.githubBaseUrl + CONFIG.files.enps;
            console.log('Loading eNPS from:', url);
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.warn('eNPS file not found, skipping');
                    return;
                }
                
                const text = await response.text();
                const lines = text.split('\n');
                const headers = lines[0].split(';');
                
                dashboardData.enpsData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(';');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index] ? values[index].trim() : '';
                        });
                        dashboardData.enpsData.push(row);
                    }
                }
                
                console.log('eNPS data loaded:', dashboardData.enpsData.length, 'records');
                
            } catch (error) {
                console.warn('eNPS file error:', error.message);
            }
        }

        function processData() {
            // Извлекаем уникальные значения для фильтров
            const branches = new Set();
            const years = new Set();
            
            dashboardData.hrData.forEach(row => {
                // Пытаемся найти колонки по разным названиям
                const branchValue = row['РФ'] || row['Филиал'] || row['Branch'] || row['Регион'];
                const yearValue = row['Год'] || row['Year'] || row['Год отчета'];
                
                if (branchValue) branches.add(branchValue);
                if (yearValue) years.add(yearValue);
            });
            
            dashboardData.branches = Array.from(branches).sort();
            dashboardData.years = Array.from(years).sort();
            
            console.log('Processed data - Branches:', dashboardData.branches.length, 'Years:', dashboardData.years.length);
        }

        function setupFilters() {
            // Заполняем селекты
            populateSelect(elements.branchSelect, dashboardData.branches);
            populateSelect(elements.yearSelect, dashboardData.years);
            populateSelect(elements.monthSelect, dashboardData.months);
        }

        function populateSelect(selectElement, options) {
            // Сохраняем первую опцию (placeholder)
            const placeholder = selectElement.options[0];
            selectElement.innerHTML = '';
            selectElement.appendChild(placeholder);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
        }

        function updateDashboard() {
            updateKPICards();
            updateTable();
            updateChart();
        }

        function updateKPICards() {
            const filteredData = getFilteredData();
            
            // Базовые KPI
            const kpis = [
                {
                    title: 'Средняя текучесть',
                    value: calculateAverage(filteredData, 'Текучесть'),
                    format: 'percent',
                    icon: 'arrow-repeat'
                },
                {
                    title: 'Укомплектованность',
                    value: calculateAverage(filteredData, 'Укомплектованность, %'),
                    format: 'percent',
                    icon: 'people'
                },
                {
                    title: 'Всего записей',
                    value: filteredData.length,
                    format: 'number',
                    icon: 'list-ul'
                }
            ];

            elements.kpiCards.innerHTML = '';
            
            kpis.forEach(kpi => {
                const card = document.createElement('div');
                card.className = 'col-md-4';
                card.innerHTML = `
                    <div class="kpi-card text-center">
                        <div><i class="bi bi-${kpi.icon} fs-1 text-primary"></i></div>
                        <div class="kpi-value mt-2">${formatValue(kpi.value, kpi.format)}</div>
                        <div class="text-muted">${kpi.title}</div>
                    </div>
                `;
                elements.kpiCards.appendChild(card);
            });
        }

        function updateTable() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                elements.tableHeader.innerHTML = '<th>Нет данных</th>';
                elements.tableBody.innerHTML = '<tr><td>Данные не найдены для выбранных фильтров</td></tr>';
                return;
            }

            // Создаем заголовки таблицы
            const headers = Object.keys(filteredData[0]);
            elements.tableHeader.innerHTML = '';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                elements.tableHeader.appendChild(th);
            });

            // Заполняем данные
            elements.tableBody.innerHTML = '';
            filteredData.slice(0, 100).forEach(row => { // Ограничиваем 100 строками для производительности
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                elements.tableBody.appendChild(tr);
            });
        }

        function updateChart() {
            const filteredData = getFilteredData();
            
            if (currentChart) {
                currentChart.destroy();
            }

            if (filteredData.length === 0) {
                return;
            }

            // Группируем данные по месяцам для графика
            const chartData = {};
            filteredData.forEach(row => {
                const month = row['Месяц'] || row['Month'] || 'Неизвестно';
                const turnover = parseFloat(row['Текучесть'] || row['Turnover'] || 0);
                
                if (!chartData[month]) {
                    chartData[month] = [];
                }
                chartData[month].push(turnover);
            });

            const labels = Object.keys(chartData);
            const data = labels.map(month => {
                const values = chartData[month];
                return values.reduce((sum, val) => sum + val, 0) / values.length;
            });

            const ctx = elements.mainChart.getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Средняя текучесть',
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(1) + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Текучесть: ' + (context.raw * 100).toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function getFilteredData() {
            let filtered = [...dashboardData.hrData];
            
            const selectedBranch = elements.branchSelect.value;
            const selectedYear = elements.yearSelect.value;
            const selectedMonth = elements.monthSelect.value;
            
            if (selectedBranch) {
                filtered = filtered.filter(row => 
                    (row['РФ'] || row['Филиал'] || row['Branch'] || row['Регион']) === selectedBranch
                );
            }
            
            if (selectedYear) {
                filtered = filtered.filter(row => 
                    String(row['Год'] || row['Year'] || row['Год отчета']) === selectedYear
                );
            }
            
            if (selectedMonth) {
                filtered = filtered.filter(row => 
                    (row['Месяц'] || row['Month']) === selectedMonth
                );
            }
            
            return filtered;
        }

        function calculateAverage(data, field) {
            const values = data
                .map(row => parseFloat(row[field] || 0))
                .filter(val => !isNaN(val));
            
            if (values.length === 0) return 0;
            return values.reduce((sum, val) => sum + val, 0) / values.length;
        }

        function formatValue(value, format) {
            if (isNaN(value)) return '0';
            
            switch (format) {
                case 'percent':
                    return (value * 100).toFixed(1) + '%';
                case 'number':
                    return Math.round(value).toLocaleString();
                default:
                    return value.toFixed(2);
            }
        }

        function exportToExcel() {
            const filteredData = getFilteredData();
            
            if (filteredData.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(filteredData);
            XLSX.utils.book_append_sheet(wb, ws, "HR Data");
            
            const filename = `HR_Dashboard_Export_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = elements.themeToggle.querySelector('i');
            icon.className = newTheme === 'dark' ? 'bi bi-sun' : 'bi bi-moon';
            
            // Обновляем график для новой темы
            if (currentChart) {
                updateChart();
            }
        }

        function showLoading() {
            elements.loadingSpinner.style.display = 'flex';
            elements.errorContainer.style.display = 'none';
            elements.dashboardContainer.classList.remove('loaded');
        }

        function showError(message) {
            elements.loadingSpinner.style.display = 'none';
            elements.errorContainer.style.display = 'block';
            elements.errorMessage.textContent = message;
            elements.dashboardContainer.classList.remove('loaded');
        }

        function showDashboard() {
            elements.loadingSpinner.style.display = 'none';
            elements.errorContainer.style.display = 'none';
            elements.dashboardContainer.classList.add('loaded');
        }

        // Загрузка сохраненной темы
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        if (savedTheme === 'dark') {
            elements.themeToggle.querySelector('i').className = 'bi bi-sun';
        }
    </script>
</body>
</html>